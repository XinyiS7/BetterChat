<!DOCTYPE html><html lang="zh"><head>    <meta charset="UTF-8">    <title>AI Chat</title></head><body>    <header>AI chat</header>    <main>        <!-- 左侧对话列表 -->        <div class="sidebar-left">            <div class="section">                <h3>对话列表</h3>                <p>默认的长期保存对话，可通过点击加载到 chat window<br>保存在后端 django 数据库中</p>            </div>        </div>        <!-- 中间对话窗口 -->        <div class="chat-window">            <div id="chat-window" class="chat-content"></div>            <!-- 表单区域，只用来处理所有提交。被提交的需要一个 name 以供后端识别 -->            <form method="post" action="/chat/">                {% csrf_token %}                <div class="control-panel">                    <label><input type="checkbox" name="mode" checked>                        mode</label>                    <label><input type="checkbox" name="abstract"                                  checked>                        abstract</label>                    <label><input type="checkbox" name="keep" checked>                        keep</label>                    <button>↓</button>                </div>                <textarea id="chat-input" name="usr_input" placeholder="请输入内容..."                          rows="12"></textarea>                <button type="submit" id="send-button">发送</button>            </form>>        </div>        <!-- 右侧 prompt 和临时对话 -->        <div class="sidebar-right">            <div id="prompt-section" class="section">                <h3>Prompt list</h3>                <!-- Prompt Checkbox 区域 -->                <div id="prompt-checkbox-group" class="checkbox-group">                    <label><input type="checkbox" name="prompt" value="选项一"> 选项一</label>                    <label><input type="checkbox" name="prompt" value="选项二"> 选项二</label>                    <label><input type="checkbox" name="prompt" value="选项三"> 选项三</label>                </div>                <!-- 管理按钮 -->                <button type="button" onclick="openPromptManager()">管理</button>            </div>            <!-- 弹出式 Prompt 管理窗口 -->            <div id="prompt-manager" style="display:none; position:fixed; top:20%; left:30%; background:#fff; border:1px solid #ccc; padding:20px; box-shadow: 0 0 10px #aaa;">                <h4>管理 Prompt 选项</h4>                <div id="prompt-edit-list"></div>                <!-- 添加新项 -->                <input type="text" id="new-prompt-input" placeholder="新增 prompt 内容">                <button type="button" onclick="addPromptOption()">添加</button>                <!-- 操作按钮 -->                <div style="margin-top:10px;">                    <button onclick="savePromptEdits()">保存</button>                    <button onclick="closePromptManager()">取消</button>                </div>            </div>            <div class="section">                <h3>临时对话</h3>                <p>临时对话，在 django 数据库中会在 7 天后自动删除</p>            </div>        </div>    </main>    <!-- ✅ 在这里引入 marked.js -->    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>    <!-- ✅ 样式文件（GitHub 风格）-->    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/github.min.css">    <!-- ✅ 高亮脚本（浏览器版本）-->    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/build/highlight.min.js"></script>    <script>        // 获取当前 prompt 列表        function getPromptOptions() {            const checkboxes = document.querySelectorAll('#prompt-checkbox-group input[type="checkbox"]');            return Array.from(checkboxes).map(cb => cb.value);        }        function openPromptManager() {            const editList = document.getElementById("prompt-edit-list");            editList.innerHTML = "";            const prompts = getPromptOptions();            prompts.forEach((text, idx) => {                const row = document.createElement("div");                row.innerHTML = `                    <input type="text" value="${text}" data-index="${idx}">                    <button onclick="deletePromptRow(this)">删除</button>                `;                editList.appendChild(row);            });            document.getElementById("prompt-manager").style.display = "block";        }        function closePromptManager() {            document.getElementById("prompt-manager").style.display = "none";        }        function deletePromptRow(btn) {            btn.parentElement.remove();        }        function addPromptOption() {            const newValue = document.getElementById("new-prompt-input").value.trim();            if (!newValue) return;            const row = document.createElement("div");            row.innerHTML = `                <input type="text" value="${newValue}">                <button onclick="deletePromptRow(this)">删除</button>            `;            document.getElementById("prompt-edit-list").appendChild(row);            document.getElementById("new-prompt-input").value = "";        }        function savePromptEdits() {            const inputs = document.querySelectorAll("#prompt-edit-list input[type='text']");            const values = Array.from(inputs).map(i => i.value.trim()).filter(v => v);            // 清空旧的 checkbox 区域            const group = document.getElementById("prompt-checkbox-group");            group.innerHTML = "";            // 重建 checkbox 列表            values.forEach(v => {                const label = document.createElement("label");                label.innerHTML = `<input type="checkbox" name="prompt" value="${v}"> ${v}`;                group.appendChild(label);            });            closePromptManager();        }        //fetch 异步处理表单实现无刷新交互        document.querySelector("form").addEventListener("submit", function (event) {            event.preventDefault();  // 阻止表单默认提交刷新            const inputElem = document.querySelector("#chat-input");            const chatWindow = document.querySelector("#chat-window");            const userInput = inputElem.value.trim();            if (!userInput) return;            // 1. // 添加用户输入到 chat window（右边）                const userBubble = document.createElement("div");                userBubble.className = "chat-bubble user-bubble";                userBubble.innerHTML = marked.parse(usr_input);                chatWindow.appendChild(userBubble);                // 清空输入框                inputBox.value = "";            // 2. 收集复选框选项            const mod = document.querySelector('input[name="mode"]').checked                ? "on" : "";            const abstr = document.querySelector('input[name="abstract"]')                .checked ? "on" : "";            const perm = document.querySelector('input[name="keep"]').checked ?                "on" : "";            // 3. 异步发送给后端            fetch("/chat/", {                method: "POST",                headers: {                    "Content-Type": "application/x-www-form-urlencoded",                    "X-CSRFToken": getCookie("csrftoken"),  // 确保模板里有 {% csrf_token %}                },                body: new URLSearchParams({                    usrinput: userInput,                    mode: mod,                    abstract: abstr,                    keep: perm                }),            })            .then(response => response.json())            .then(data => {                // 4. 显示 AI 回复                const reply = data.reply || "（AI未返回回复）";                chatWindow.innerHTML += `<div class="ai-msg"><strong>AI：</strong> ${reply}</div>`;                // 5. 滚动到底部                const aiBubble = document.createElement("div");                aiBubble.className = "chat-bubble ai-bubble";                aiBubble.innerHTML = marked.parse(ai_reply);                chatWindow.appendChild(aiBubble);                // 自动滚动到底部                chatWindow.scrollTop = chatWindow.scrollHeight;            })            .catch(error => {                const errBubble = document.createElement("div");                errBubble.className = "chat-bubble error-bubble";                errBubble.innerText = "⚠️ 出错: " + error.message;                chatWindow.appendChild(errBubble);            });        });        //展示对话        /*        document.getElementById("send-button").addEventListener("click",            function () {                const inputBox = document.getElementById("chat-input");                const chatWindow = document.getElementById("chat-window");                const usr_input = inputBox.value.trim();                if (!usr_input) return;                // 添加用户输入到 chat window（右边）                const userBubble = document.createElement("div");                userBubble.className = "chat-bubble user-bubble";                userBubble.innerHTML = marked.parse(usr_input);                chatWindow.appendChild(userBubble);                // 清空输入框                inputBox.value = "";                // 模拟 AI 回复（你之后可用 fetch 代替这里）                const ai_reply = `            **这是 AI 回复：**            - 支持 Markdown            - 支持代码块            \`\`\`python            print("Hello World")            \`\`\`            `;                //处理可能存在的markdown渲染问题                marked.setOptions({                    highlight: function (code, lang) {                        const language = hljs.getLanguage(lang) ? lang : 'plaintext';                        return hljs.highlight(code, {language}).value;                    }                });                // 延时模拟后端响应（可省略）                setTimeout(() => {                    const aiBubble = document.createElement("div");                    aiBubble.className = "chat-bubble ai-bubble";                    aiBubble.innerHTML = marked.parse(ai_reply);                    chatWindow.appendChild(aiBubble);                    // 自动滚动到底部                    chatWindow.scrollTop = chatWindow.scrollHeight;                }, 300);  // 假装等了下后端返回            });         */    </script></body></html>